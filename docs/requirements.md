# Expo Updates Admin 需求文档

## 1. 项目概述

### 1.1 项目背景
Expo Updates Admin 是一个用于管理基于 Expo 框架开发的移动应用热更新平台。该平台支持同时管理多个应用的热更新发布、版本控制和用户分发策略。

### 1.2 核心目标
- 集中管理多个 Expo 应用的热更新
- 提供灵活的更新分发策略（全量更新、定向更新）
- 支持版本回滚和特定用户版本管理
- 提供直观的 Web 管理界面
- 完整的操作日志和统计分析功能

### 1.3 技术架构
- **前端框架**：Next.js 15 + React 19
- **UI 组件库**：shadcn/ui + Tailwind CSS 4
- **架构模式**：Monorepo（pnpm workspaces + Turbo）
- **包管理**：pnpm
- **类型系统**：TypeScript 5.9
- **状态管理**：React Hooks（可扩展）
- **表单处理**：React Hook Form + Zod

### 1.4 项目状态
- **UI 实现状态**：✅ 已完成（所有页面UI已完成）
- **功能实现状态**：🚧 进行中（使用模拟数据，API待实现）
- **后端API**：⏳ 待实现

## 2. 用户角色

### 2.1 管理员（Admin）
- 拥有所有功能的完全访问权限
- 可以管理所有应用
- 可以管理系统用户和权限
- 可以查看所有操作日志

### 2.2 应用管理员（App Manager）
- 可以管理被分配的应用
- 可以发布更新、回滚版本
- 可以管理用户分发策略
- 可以查看应用的操作日志

### 2.3 查看者（Viewer）
- 仅能查看应用状态和更新历史
- 无法执行更新或回滚操作
- 可以查看统计信息

## 3. 功能需求

### 3.1 用户认证

#### 3.1.1 登录功能
**实现状态**：✅ UI完成，⏳ 功能待实现

**需求描述**：
- 用户通过邮箱和密码登录系统
- 支持记住登录状态（可选）
- 登录失败时显示错误提示

**已实现功能点**：
- ✅ 登录表单UI（邮箱 + 密码）
- ✅ 表单验证（前端）
- ✅ 记住我选项UI
- ✅ 忘记密码链接UI

**待实现功能点**：
- [ ] 登录API集成
- [ ] 登录状态持久化
- [ ] Token管理
- [ ] 登录成功后跳转到应用列表页
- [ ] 错误提示显示

#### 3.1.2 登出功能
**实现状态**：✅ UI完成，⏳ 功能待实现

**需求描述**：
- 用户可以安全退出登录
- 登出后清除登录状态并跳转到登录页

**已实现功能点**：
- ✅ 登出按钮/菜单项（侧边栏用户菜单）

**待实现功能点**：
- [ ] 登出API调用
- [ ] 清除认证状态
- [ ] 跳转到登录页

#### 3.1.3 会话管理
**实现状态**：⏳ 待实现

**需求描述**：
- 自动检测登录状态
- Token 过期时自动跳转登录
- 支持刷新 Token

**待实现功能点**：
- [ ] Token 验证中间件
- [ ] 自动跳转登录
- [ ] Token 刷新机制
- [ ] 路由守卫

### 3.2 应用管理

#### 3.2.1 应用列表页
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/apps`

**需求描述**：
- 显示用户有权限访问的所有应用
- 展示每个应用的基本信息和状态
- 支持搜索和筛选功能（待实现）

**已实现功能点**：
- ✅ 应用卡片展示
  - 应用名称、图标
  - 应用 ID
  - 当前版本信息
  - 用户数统计
  - 最后更新时间
  - 应用状态标识
- ✅ 统计信息卡片
  - 总应用数
  - 总用户数
  - 总更新次数
- ✅ 点击应用卡片进入应用详情页
- ✅ 响应式布局

**待实现功能点**：
- [ ] 搜索功能（按应用名称）
- [ ] 筛选功能（按状态、最近更新）
- [ ] API数据对接
- [ ] 分页加载

#### 3.2.2 应用详情页
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/apps/[appId]`

**需求描述**：
- 进入特定应用的热更新管理界面
- 展示该应用的详细信息、版本历史、更新统计

**已实现功能点**：
- ✅ 应用基本信息展示
  - 应用名称、图标
  - 应用 ID
  - 创建时间
  - 负责人信息
  - 应用描述
- ✅ 当前版本信息卡片
- ✅ 快速统计卡片（版本数、用户数、更新次数、最后更新）
- ✅ 应用信息卡片
- ✅ 快速操作入口
  - 发布新更新
  - 版本回滚
  - 查看所有版本
  - 管理用户
- ✅ 响应式布局

**待实现功能点**：
- [ ] API数据对接
- [ ] 实时数据更新
- [ ] 应用设置功能

### 3.3 热更新管理

#### 3.3.1 版本列表
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/apps/[appId]/versions`

**需求描述**：
- 显示应用的所有版本历史
- 展示每个版本的详细信息

**已实现功能点**：
- ✅ 版本列表表格展示
  - 版本号
  - 版本名称
  - 版本描述
  - 版本状态（已发布/已回滚/草稿）
  - 文件大小
  - 用户数
  - 发布时间
  - 发布人
  - 强制更新标识
- ✅ 版本操作下拉菜单
  - 下载更新包
  - 回滚版本（已发布版本）
  - 编辑/删除（草稿版本）
- ✅ 统计信息展示

**待实现功能点**：
- [ ] API数据对接
- [ ] 版本筛选（按状态、时间范围）
- [ ] 版本排序（按时间、版本号）
- [ ] 版本详情查看对话框
- [ ] 版本操作功能实现
- [ ] 分页加载

#### 3.3.2 发布新更新
**实现状态**：✅ UI完成，⏳ 功能待实现

**路径**：`/apps/[appId]/versions/new`

**需求描述**：
- 上传新的更新包并发布
- 配置更新信息

**已实现功能点**：
- ✅ 更新包上传UI
  - 拖拽上传支持
  - 文件选择
  - 文件格式验证（前端）
  - 文件大小验证（前端，100MB限制）
  - 上传进度显示
- ✅ 版本信息填写表单
  - 版本号输入
  - 版本名称输入
  - 更新说明文本域
  - 更新类型选择（可选/强制）
  - 发布时间选择（立即发布/定时发布）
  - 定时发布日期时间选择
- ✅ 发布确认对话框
- ✅ 表单验证（前端）

**待实现功能点**：
- [ ] 文件上传API实现
- [ ] 文件上传进度跟踪
- [ ] 文件校验（服务端）
- [ ] 版本创建API
- [ ] 定时发布任务创建
- [ ] 发布成功后的跳转和通知

#### 3.3.3 全量更新
**实现状态**：⏳ 待实现（可通过发布新更新实现）

**需求描述**：
- 将更新推送到所有使用该应用的用户
- 可以立即发布或定时发布

**待实现功能点**：
- [ ] 选择已上传的版本
- [ ] 配置发布策略
  - 立即发布
  - 定时发布
  - 分批发布（灰度发布）
- [ ] 发布确认对话框
- [ ] 发布进度跟踪
- [ ] 发布结果通知

#### 3.3.4 版本回滚
**实现状态**：✅ UI完成，⏳ 功能待实现

**需求描述**：
- 将应用回滚到之前的某个版本
- 支持全量回滚和选择性回滚

**已实现功能点**：
- ✅ 版本列表中的回滚操作入口

**待实现功能点**：
- [ ] 回滚对话框UI
- [ ] 选择要回滚到的目标版本
- [ ] 回滚原因填写
- [ ] 回滚范围选择（全量/部分用户）
- [ ] 回滚确认对话框
- [ ] 回滚API实现
- [ ] 回滚结果通知

### 3.4 用户分发管理

#### 3.4.1 用户列表
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/apps/[appId]/users`

**需求描述**：
- 显示应用的用户列表
- 展示用户的版本信息和状态

**已实现功能点**：
- ✅ 用户列表表格展示
  - 用户 ID
  - 设备 ID
  - 平台标识（iOS/Android）
  - 当前版本
  - 系统版本
  - 在线状态
  - 最后更新时间
- ✅ 统计信息卡片
  - 总用户数
  - 在线用户数
  - 离线用户数
  - 版本数
- ✅ 搜索框UI
- ✅ 筛选选择器UI（版本、状态）
- ✅ 用户操作下拉菜单
  - 更新到最新版本
  - 回滚版本
  - 导出信息

**待实现功能点**：
- [ ] API数据对接
- [ ] 搜索功能实现
- [ ] 筛选功能实现
- [ ] 用户操作功能实现
- [ ] 批量操作功能
- [ ] 分页加载

#### 3.4.2 定向更新
**实现状态**：⏳ 待实现

**需求描述**：
- 将特定版本推送给选定的用户或用户组
- 支持创建用户分组

**待实现功能点**：
- [ ] 定向更新对话框
- [ ] 选择目标用户
  - 单个用户选择
  - 用户组选择
  - 批量选择
- [ ] 选择更新版本
- [ ] 配置更新策略
  - 立即更新
  - 定时更新
- [ ] 更新确认
- [ ] 更新任务创建和跟踪

#### 3.4.3 用户版本回滚
**实现状态**：✅ UI完成（在用户列表中），⏳ 功能待实现

**需求描述**：
- 将特定用户回滚到指定版本
- 支持批量用户回滚

**已实现功能点**：
- ✅ 用户列表中的回滚操作入口

**待实现功能点**：
- [ ] 用户回滚对话框
- [ ] 选择回滚到的版本
- [ ] 填写回滚原因
- [ ] 回滚确认
- [ ] 回滚API实现
- [ ] 回滚状态跟踪

#### 3.4.4 用户分组管理
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/apps/[appId]/users/groups`

**需求描述**：
- 创建和管理用户分组
- 便于批量操作

**已实现功能点**：
- ✅ 分组列表表格展示
- ✅ 创建新分组对话框
  - 分组名称输入
  - 分组描述文本域
- ✅ 编辑分组对话框
- ✅ 删除分组功能（前端）
- ✅ 搜索分组功能（前端）
- ✅ 分组操作菜单
  - 编辑分组
  - 管理用户（待实现功能）
  - 删除分组

**待实现功能点**：
- [ ] API数据对接
- [ ] 分组用户管理功能
- [ ] 添加用户到分组
- [ ] 从分组移除用户
- [ ] 分组详情查看

### 3.5 统计与分析

#### 3.5.1 更新统计
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/apps/[appId]/stats`

**需求描述**：
- 展示应用的更新统计信息

**已实现功能点**：
- ✅ 版本分布统计展示
  - 各版本用户数
  - 版本占比可视化
- ✅ 更新成功率统计展示
  - 成功/失败数量
  - 成功率百分比
- ✅ 更新时间分布展示
  - 最近5天更新次数柱状图
- ✅ 更新失败原因分析展示
- ✅ 统计摘要卡片
  - 更新成功率
  - 活跃版本数
  - 总更新次数

**待实现功能点**：
- [ ] API数据对接
- [ ] 图表库集成（如需）
- [ ] 时间范围选择器
- [ ] 数据导出功能

#### 3.5.2 操作日志
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/apps/[appId]/logs`

**需求描述**：
- 记录所有更新和回滚操作

**已实现功能点**：
- ✅ 操作日志列表展示
  - 操作类型图标和名称
  - 操作描述
  - 操作状态（成功/失败）
  - 操作人
  - 操作时间
  - 详情查看按钮
- ✅ 搜索框UI
- ✅ 筛选选择器UI（类型、状态）
- ✅ 日志导出按钮

**待实现功能点**：
- [ ] API数据对接
- [ ] 日志筛选和搜索功能
- [ ] 日志详情查看对话框
- [ ] 日志导出功能
- [ ] 分页加载
- [ ] 实时日志更新（可选）

### 3.6 平台用户管理

#### 3.6.1 平台用户列表
**实现状态**：✅ UI完成，⏳ 数据待对接

**路径**：`/app-users`

**需求描述**：
- 管理系统用户账号和权限

**已实现功能点**：
- ✅ 用户列表表格展示
  - 用户名
  - 邮箱
  - 角色标识（管理员/应用管理员/查看者）
  - 状态标识（活跃/禁用）
  - 创建时间
  - 最后登录时间
- ✅ 统计信息卡片
  - 总用户数
  - 活跃用户数
  - 禁用用户数
  - 管理员数量
- ✅ 搜索框UI
- ✅ 角色筛选选择器
- ✅ 用户操作菜单
  - 编辑用户
  - 重置密码
  - 启用/禁用账户
  - 删除用户
- ✅ 添加用户按钮

**待实现功能点**：
- [ ] API数据对接
- [ ] 搜索功能实现
- [ ] 筛选功能实现
- [ ] 添加用户对话框
- [ ] 编辑用户对话框
- [ ] 用户操作功能实现
- [ ] 权限管理功能

## 4. 非功能需求

### 4.1 性能需求
- 页面加载时间 < 2 秒
- API 响应时间 < 500ms
- 支持大文件上传（至少 100MB）
- 列表分页加载，单页不超过 50 条
- 支持虚拟滚动（大量数据时）

### 4.2 安全需求
- 所有 API 请求需要身份认证
- 敏感操作需要二次确认
- 操作日志完整记录
- 用户权限控制（基于角色的访问控制）
- 数据传输加密（HTTPS）
- Token 安全存储
- 密码加密传输和存储

### 4.3 可用性需求
- 界面友好，操作直观
- 响应式设计，支持桌面和移动端访问
- 错误提示清晰明确
- 操作成功/失败有明确反馈
- 支持暗色模式（已实现）
- 加载状态提示
- 空状态提示

### 4.4 兼容性需求
- 支持主流浏览器（Chrome, Firefox, Safari, Edge）
- 支持移动端浏览器访问
- 最低支持 Node.js 20.0.0
- 支持现代浏览器（ES2020+）

### 4.5 可维护性需求
- 代码模块化，职责清晰
- 使用 TypeScript 保证类型安全
- 完善的错误处理机制
- 统一的代码风格和规范（ESLint + Prettier）
- 组件化开发（shadcn/ui）
- Monorepo 架构便于维护

## 5. 页面结构

### 5.1 路由结构

```
/                           → 登录页（未登录）或应用列表页（已登录）
/login                      → 登录页
/apps                       → 应用列表页 ✅
/apps/[appId]               → 应用详情页 ✅
/apps/[appId]/versions      → 版本列表页 ✅
/apps/[appId]/versions/new  → 发布新更新页 ✅
/apps/[appId]/users         → 用户列表页 ✅
/apps/[appId]/users/groups  → 用户分组管理页 ✅
/apps/[appId]/stats         → 统计页面 ✅
/apps/[appId]/logs          → 操作日志页 ✅
/app-users                  → 平台用户管理页 ✅
```

### 5.2 页面布局

#### 5.2.1 登录页
- ✅ 登录表单
- ✅ 品牌 Logo（Expo Updates）
- ✅ 渐变背景
- ✅ 忘记密码链接

#### 5.2.2 主布局（已登录）
- ✅ 侧边栏导航
  - Logo 和标题
  - 平台级菜单（应用管理、用户管理）
  - 应用级菜单（概览、版本管理、用户管理、统计分析、操作日志）
  - 用户菜单（头像、设置、退出登录）
  - 折叠/展开功能
  - 移动端响应式菜单
- ✅ 主内容区
  - 页面标题和描述
  - 面包屑导航（可扩展）
  - 页面内容
  - 响应式布局

## 6. 数据模型

### 6.1 应用（App）
```typescript
interface App {
  id: string              // 应用唯一标识
  name: string            // 应用名称
  icon?: string           // 应用图标 URL
  description?: string    // 应用描述
  appId: string           // Expo App ID
  createdAt: Date         // 创建时间
  updatedAt: Date         // 更新时间
  status: 'active' | 'inactive'  // 状态
  ownerId: string         // 负责人 ID
  currentVersion?: string  // 当前版本号
  userCount?: number      // 用户数
  updateCount?: number     // 更新次数
}
```

### 6.2 版本（Version）
```typescript
interface Version {
  id: string              // 版本唯一标识
  appId: string           // 所属应用 ID
  version: string         // 版本号（如 1.0.0）
  name: string            // 版本名称
  description?: string    // 版本说明
  fileUrl: string         // 更新包文件 URL
  fileSize: number        // 文件大小（字节）
  checksum: string        // 文件校验和
  isMandatory: boolean    // 是否强制更新
  status: 'draft' | 'published' | 'rolled_back'  // 状态
  publishedAt?: Date      // 发布时间
  rolledBackAt?: Date     // 回滚时间
  publishedBy: string      // 发布人 ID
  userCount: number       // 使用该版本的用户数
  createdAt: Date         // 创建时间
}
```

### 6.3 用户（User - 应用用户）
```typescript
interface AppUser {
  id: string              // 用户唯一标识
  appId: string           // 所属应用 ID
  deviceId: string        // 设备 ID
  userId?: string         // 用户 ID（如果应用有用户系统）
  currentVersion: string  // 当前版本号
  lastUpdateAt: Date      // 最后更新时间
  deviceInfo?: {          // 设备信息
    platform: 'ios' | 'android'
    osVersion: string
    appVersion: string
  }
  status: 'online' | 'offline'  // 在线状态
}
```

### 6.4 更新任务（UpdateTask）
```typescript
interface UpdateTask {
  id: string              // 任务唯一标识
  appId: string           // 所属应用 ID
  versionId: string       // 目标版本 ID
  type: 'full' | 'targeted'  // 更新类型
  targetUserIds?: string[]   // 目标用户 ID 列表（定向更新）
  targetGroupIds?: string[]  // 目标分组 ID 列表
  status: 'pending' | 'in_progress' | 'completed' | 'failed'  // 任务状态
  scheduledAt?: Date      // 计划执行时间
  startedAt?: Date        // 开始时间
  completedAt?: Date      // 完成时间
  successCount: number    // 成功数量
  failureCount: number    // 失败数量
  createdBy: string       // 创建人 ID
  createdAt: Date         // 创建时间
}
```

### 6.5 回滚任务（RollbackTask）
```typescript
interface RollbackTask {
  id: string              // 任务唯一标识
  appId: string           // 所属应用 ID
  fromVersionId: string   // 当前版本 ID
  toVersionId: string     // 目标版本 ID
  type: 'full' | 'targeted'  // 回滚类型
  targetUserIds?: string[]   // 目标用户 ID 列表
  targetGroupIds?: string[]  // 目标分组 ID 列表
  reason: string          // 回滚原因
  status: 'pending' | 'in_progress' | 'completed' | 'failed'  // 任务状态
  scheduledAt?: Date      // 计划执行时间
  startedAt?: Date        // 开始时间
  completedAt?: Date      // 完成时间
  successCount: number    // 成功数量
  failureCount: number    // 失败数量
  createdBy: string       // 创建人 ID
  createdAt: Date         // 创建时间
}
```

### 6.6 用户分组（UserGroup）
```typescript
interface UserGroup {
  id: string              // 分组唯一标识
  appId: string           // 所属应用 ID
  name: string            // 分组名称
  description?: string    // 分组描述
  userIds: string[]       // 用户 ID 列表
  userCount: number       // 用户数量
  createdAt: Date         // 创建时间
  updatedAt: Date         // 更新时间
  createdBy: string       // 创建人 ID
}
```

### 6.7 操作日志（OperationLog）
```typescript
interface OperationLog {
  id: string              // 日志唯一标识
  appId: string           // 所属应用 ID
  type: 'update' | 'rollback' | 'version_create' | 'version_delete' | 'user_update'  // 操作类型
  action: string          // 操作描述
  targetId: string         // 目标对象 ID（版本 ID、用户 ID 等）
  targetType: string      // 目标类型（version、user 等）
  status: 'success' | 'failed'  // 操作结果
  details?: object        // 操作详情（JSON）
  userId: string          // 操作人 ID
  createdAt: Date         // 操作时间
}
```

### 6.8 平台用户（PlatformUser）
```typescript
interface PlatformUser {
  id: string              // 用户唯一标识
  name: string            // 用户名
  email: string           // 邮箱
  password?: string       // 密码（加密存储，查询时不返回）
  role: 'admin' | 'app_manager' | 'viewer'  // 角色
  status: 'active' | 'inactive'  // 状态
  createdAt: Date         // 创建时间
  lastLoginAt?: Date      // 最后登录时间
  appIds?: string[]       // 有权限管理的应用 ID 列表（app_manager 角色）
}
```

## 7. 开发优先级

### Phase 1: 核心功能（MVP）- 当前阶段
1. ✅ 用户登录/登出（UI完成）
2. ✅ 应用列表页（UI完成）
3. ✅ 应用详情页（UI完成）
4. ✅ 版本列表（UI完成）
5. ✅ 发布新更新（UI完成）
6. ⏳ 后端API实现
   - [ ] 认证API
   - [ ] 应用API
   - [ ] 版本API
   - [ ] 文件上传API

### Phase 2: 增强功能
1. ⏳ 版本回滚（全量）
2. ✅ 用户列表（UI完成）
3. ⏳ 定向更新
4. ⏳ 用户版本回滚
5. ✅ 基础统计（UI完成）
6. ⏳ API数据对接

### Phase 3: 高级功能
1. ✅ 用户分组管理（UI完成）
2. ✅ 操作日志（UI完成）
3. ⏳ 详细统计和分析（数据对接）
4. ⏳ 定时发布
5. ⏳ 灰度发布
6. ⏳ 平台用户管理功能实现

## 8. 技术实现要点

### 8.1 前端实现
- ✅ 使用 Next.js App Router 进行路由管理
- ✅ 使用 React Server Components 提升性能
- ✅ 使用 shadcn/ui 组件构建界面
- ✅ 实现文件上传组件（支持拖拽）
- ✅ 实现表格、表单、图表等组件
- ⏳ 实现客户端状态管理（如需）
- ⏳ API客户端封装
- ⏳ 错误处理机制

### 8.2 状态管理
- ⏳ 认证状态（Token、用户信息）
- ⏳ 当前应用选择状态
- ✅ 表单状态（React Hook Form）
- ⏳ 列表数据缓存

### 8.3 错误处理
- ⏳ 统一的错误处理机制
- ✅ 友好的错误提示UI
- ⏳ API 错误状态码处理
- ⏳ 网络错误处理

### 8.4 性能优化
- ✅ 代码分割（Next.js自动）
- ⏳ 列表虚拟滚动（如需要）
- ⏳ 图片懒加载
- ⏳ API 数据缓存
- ⏳ React Query/SWR 集成（可选）

## 9. 后续扩展方向

- 多环境支持（开发、测试、生产）
- 更新策略模板
- 自动化测试集成
- 通知和告警系统
- 移动端管理 App
- API SDK 和文档
- Webhook 支持
- 批量操作优化
- 实时通知（WebSocket）
- 更多图表和可视化

## 10. 已知问题和待优化

### 已知问题
1. 所有页面使用模拟数据，需要对接真实API
2. 文件上传功能未实现，需要实现上传API
3. 认证功能未实现，需要实现登录/登出API
4. 表单验证仅前端，需要服务端验证

### 待优化项
1. 添加加载状态指示器
2. 优化移动端体验
3. 添加更多的错误边界
4. 实现数据缓存策略
5. 添加单元测试和集成测试
6. 优化大文件上传体验
7. 实现批量操作功能
8. 添加操作确认对话框
